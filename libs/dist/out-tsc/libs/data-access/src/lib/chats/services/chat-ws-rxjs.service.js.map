{"version":3,"file":"chat-ws-rxjs.service.js","sourceRoot":"","sources":["../../../../../../../../data-access/src/lib/chats/services/chat-ws-rxjs.service.ts"],"names":[],"mappings":"AASA,OAAO,EAAE,SAAS,EAAE,MAAM,gBAAgB,CAAC;AAC3C,OAAO,EAAE,QAAQ,EAAE,GAAG,EAAE,MAAM,MAAM,CAAC;AAErC,MAAM,OAAO,iBAAiB;IAC5B,OAAO,GAA2C,IAAI,CAAC;IAEvD,OAAO,CAAC,MAA8B;QACpC,IAAI,CAAC,IAAI,CAAC,OAAO,EAAE;YACjB,IAAI,CAAC,OAAO,GAAG,SAAS,CAAC;gBACvB,GAAG,EAAE,MAAM,CAAC,GAAG;gBACf,QAAQ,EAAE,CAAC,MAAM,CAAC,KAAK,CAAC;aACzB,CAAC,CAAC;SACJ;QAED,OAAO,IAAI,CAAC,OAAO,CAAC,YAAY,EAAE,CAAC,IAAI,CACrC,GAAG,CAAC,CAAC,OAAO,EAAE,EAAE,CAAC,MAAM,CAAC,aAAa,CAAC,OAA+B,CAAC,CAAC,EACvE,QAAQ,CAAC,GAAG,EAAE,CAAC,OAAO,CAAC,GAAG,CAAC,YAAY,CAAC,CAAC,CAC1C,CAAC;IACJ,CAAC;IAED,UAAU;QACR,IAAI,CAAC,OAAO,EAAE,QAAQ,EAAE,CAAC;QACzB,IAAI,CAAC,OAAO,GAAG,IAAI,CAAC;IACtB,CAAC;IAED,WAAW,CAAC,IAAY,EAAE,MAAc;QACtC,IAAI,CAAC,OAAO,EAAE,IAAI,CAAC;YACjB,IAAI;YACJ,OAAO,EAAE,MAAM;SAChB,CAAC,CAAC;IACL,CAAC;CACF","sourcesContent":["import {\r\n  ChatConnectionWSParams,\r\n  ChatWsService,\r\n} from '@tt/interfaces/chats/chat-ws-service.interface';\r\nimport { WebSocketSubject } from 'rxjs/internal/observable/dom/WebSocketSubject';\r\nimport {\r\n  ChatWSMessage,\r\n  ChatWSMessageReceive,\r\n} from '@tt/interfaces/chats/chat-ws-message.interface';\r\nimport { webSocket } from 'rxjs/webSocket';\r\nimport { finalize, tap } from 'rxjs';\r\n\r\nexport class ChatWsRxjsService implements ChatWsService {\r\n  #socket: WebSocketSubject<ChatWSMessage> | null = null;\r\n\r\n  connect(params: ChatConnectionWSParams) {\r\n    if (!this.#socket) {\r\n      this.#socket = webSocket({\r\n        url: params.url,\r\n        protocol: [params.token],\r\n      });\r\n    }\r\n\r\n    return this.#socket.asObservable().pipe(\r\n      tap((message) => params.handleMessage(message as ChatWSMessageReceive)),\r\n      finalize(() => console.log('Чат закрыт'))\r\n    );\r\n  }\r\n\r\n  disconnect(): void {\r\n    this.#socket?.complete();\r\n    this.#socket = null;\r\n  }\r\n\r\n  sendMessage(text: string, chatId: number): void {\r\n    this.#socket?.next({\r\n      text,\r\n      chat_id: chatId,\r\n    });\r\n  }\r\n}\r\n"]}