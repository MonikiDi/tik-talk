{"version":3,"file":"auth.interceptor.js","sourceRoot":"","sources":["../../../../../../../../data-access/src/lib/auth/interceptors/auth.interceptor.ts"],"names":[],"mappings":"AAKA,OAAO,EAAE,MAAM,EAAE,MAAM,eAAe,CAAC;AACvC,OAAO,EACL,eAAe,EACf,UAAU,EACV,MAAM,EACN,SAAS,EACT,GAAG,EACH,UAAU,GACX,MAAM,MAAM,CAAC;AACd,OAAO,EAAE,WAAW,EAAE,MAAM,0BAA0B,CAAC;AAEvD,IAAI,aAAa,GAAG,IAAI,eAAe,CAAU,KAAK,CAAC,CAAC;AAExD,MAAM,CAAC,MAAM,oBAAoB,GAAsB,CAAC,GAAG,EAAE,IAAI,EAAE,EAAE;IACnE,MAAM,WAAW,GAAG,MAAM,CAAC,WAAW,CAAC,CAAC;IACxC,MAAM,KAAK,GAAG,WAAW,CAAC,KAAK,CAAC;IAEhC,IAAI,CAAC,KAAK;QAAE,OAAO,IAAI,CAAC,GAAG,CAAC,CAAC;IAE7B,IAAI,aAAa,CAAC,KAAK,EAAE;QACvB,OAAO,cAAc,CAAC,WAAW,EAAE,GAAG,EAAE,IAAI,CAAC,CAAC;KAC/C;IAED,OAAO,IAAI,CAAC,QAAQ,CAAC,GAAG,EAAE,KAAK,CAAC,CAAC,CAAC,IAAI,CACpC,UAAU,CAAC,CAAC,KAAK,EAAE,EAAE;QACnB,IAAI,KAAK,CAAC,MAAM,KAAK,GAAG,EAAE;YACxB,OAAO,cAAc,CAAC,WAAW,EAAE,GAAG,EAAE,IAAI,CAAC,CAAC;SAC/C;QAED,OAAO,UAAU,CAAC,KAAK,CAAC,CAAC;IAC3B,CAAC,CAAC,CACH,CAAC;AACJ,CAAC,CAAC;AAEF,MAAM,cAAc,GAAG,CACrB,WAAwB,EACxB,GAAqB,EACrB,IAAmB,EACnB,EAAE;IACF,IAAI,CAAC,aAAa,CAAC,KAAK,EAAE;QACxB,aAAa,CAAC,IAAI,CAAC,IAAI,CAAC,CAAC;QACzB,OAAO,WAAW,CAAC,gBAAgB,EAAE,CAAC,IAAI,CACxC,SAAS,CAAC,CAAC,GAAG,EAAE,EAAE;YAChB,OAAO,IAAI,CAAC,QAAQ,CAAC,GAAG,EAAE,GAAG,CAAC,YAAY,CAAC,CAAC,CAAC,IAAI,CAC/C,GAAG,CAAC,GAAG,EAAE,CAAC,aAAa,CAAC,IAAI,CAAC,KAAK,CAAC,CAAC,CACrC,CAAC;QACJ,CAAC,CAAC,CACH,CAAC;KACH;IAED,IAAI,GAAG,CAAC,GAAG,CAAC,QAAQ,CAAC,SAAS,CAAC;QAC7B,OAAO,IAAI,CAAC,QAAQ,CAAC,GAAG,EAAE,WAAW,CAAC,KAAM,CAAC,CAAC,CAAC;IAEjD,OAAO,aAAa,CAAC,IAAI,CACvB,MAAM,CAAC,CAAC,YAAY,EAAE,EAAE,CAAC,CAAC,YAAY,CAAC,EACvC,SAAS,CAAC,CAAC,GAAG,EAAE,EAAE;QAChB,OAAO,IAAI,CAAC,QAAQ,CAAC,GAAG,EAAE,WAAW,CAAC,KAAM,CAAC,CAAC,CAAC;IACjD,CAAC,CAAC,CACH,CAAC;AACJ,CAAC,CAAC;AAEF,MAAM,QAAQ,GAAG,CAAC,GAAqB,EAAE,KAAa,EAAE,EAAE;IACxD,OAAO,GAAG,CAAC,KAAK,CAAC;QACf,UAAU,EAAE;YACV,aAAa,EAAE,UAAU,KAAK,EAAE;SACjC;KACF,CAAC,CAAC;AACL,CAAC,CAAC","sourcesContent":["import {\r\n  HttpHandlerFn,\r\n  HttpInterceptorFn,\r\n  HttpRequest,\r\n} from '@angular/common/http';\r\nimport { inject } from '@angular/core';\r\nimport {\r\n  BehaviorSubject,\r\n  catchError,\r\n  filter,\r\n  switchMap,\r\n  tap,\r\n  throwError,\r\n} from 'rxjs';\r\nimport { AuthService } from '../services/auth.service';\r\n\r\nlet isRefreshing$ = new BehaviorSubject<boolean>(false);\r\n\r\nexport const authTokenInterceptor: HttpInterceptorFn = (req, next) => {\r\n  const authService = inject(AuthService);\r\n  const token = authService.token;\r\n\r\n  if (!token) return next(req);\r\n\r\n  if (isRefreshing$.value) {\r\n    return refreshProceed(authService, req, next);\r\n  }\r\n\r\n  return next(addToken(req, token)).pipe(\r\n    catchError((error) => {\r\n      if (error.status === 403) {\r\n        return refreshProceed(authService, req, next);\r\n      }\r\n\r\n      return throwError(error);\r\n    })\r\n  );\r\n};\r\n\r\nconst refreshProceed = (\r\n  authService: AuthService,\r\n  req: HttpRequest<any>,\r\n  next: HttpHandlerFn\r\n) => {\r\n  if (!isRefreshing$.value) {\r\n    isRefreshing$.next(true);\r\n    return authService.refreshAuthToken().pipe(\r\n      switchMap((res) => {\r\n        return next(addToken(req, res.access_token)).pipe(\r\n          tap(() => isRefreshing$.next(false))\r\n        );\r\n      })\r\n    );\r\n  }\r\n\r\n  if (req.url.includes('refresh'))\r\n    return next(addToken(req, authService.token!));\r\n\r\n  return isRefreshing$.pipe(\r\n    filter((isRefreshing) => !isRefreshing),\r\n    switchMap((res) => {\r\n      return next(addToken(req, authService.token!));\r\n    })\r\n  );\r\n};\r\n\r\nconst addToken = (req: HttpRequest<any>, token: string) => {\r\n  return req.clone({\r\n    setHeaders: {\r\n      Authorization: `Bearer ${token}`,\r\n    },\r\n  });\r\n};\r\n"]}